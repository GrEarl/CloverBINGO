# DESING.md — CloverBINGO 演出/UI（CloverPitリスペクト / 会場ディスプレイ強化）
目的: CloverBINGO を「CloverPit っぽいスロットUIの気持ちよさ」で白熱させる。  
範囲: 会場表示（十の位 / 一の位）を最優先。Admin/参加者は“壊さない範囲で最小”の補助のみ。  
前提: 既存の操作・ルールは変更しない（ビンゴ大会のまま）。

---

## 1. 絶対条件（壊さない）
- Admin キー操作は維持する:
  - `P`: 次番号 prepare（Adminのみ）
  - `W/A/S/D`: GO（十/一の位が同時回転→各桁ランダム停止→確定→参加者へ反映）
- 会場表示（十の位 / 一の位）は「遠目で数字が読める」ことが最優先。
- 音（SE）はブラウザ制約があるため、Admin の「音を有効化」を前提にする（自動再生に頼らない）。
- 新しい重い依存を増やさない。CSS + Canvas2D（必要なら）で完結。
- 失敗保険:
  - `?fx=0` : 演出ほぼOFF（可読性重視の静的表示へ）
  - `?safe=1` : 粒子/シェイク/強い発光変化/過度なじらしを抑制

---

## 2. CloverPit リスペクト（“世界観”ではなく“手触り”）
コピーすべき要素（ホラー文脈やギャンブル煽りは不要）:
- スロットマシンの“機械感”:
  - 回転 → 減速 → 停止の手触り（clunk / snap / rebound）
  - 「止まる瞬間」が一番気持ちいい
- 暗い筐体 + 発光する情報:
  - 背景は暗く、数字や重要表示は発光（glow）で浮かせる
  - 画面に薄いノイズ / スキャンライン的な“質感”を足す（やり過ぎない）
- “当たり”の祝祭（短く、強く、すぐ収束）:
  - 確定時の短いインパクト → 即座に読みやすさ最大へ戻す
  - ビンゴ時は一段強い祝祭（コイン/紙吹雪的）を入れ、必ず収束させる

---

## 3. 会場表示（十の位 / 一の位）に入れるべき演出
会場表示は「数字＋背景演出＋状態ラベル」の3点だけで成立させ、情報過多にしない。

### 3.1 常時（IDLE）
- 背景: 暗いベース + ごく薄い質感（グレイン/ビネット/スキャンラインのどれか一つ）
- 発光: 外枠やアクセントがゆっくり呼吸（点滅ではなくフェード）
- 数字: 静止中でも“筐体の表示”に見えるよう、枠やガラス感（薄いハイライト）を付与

### 3.2 GO（回転開始）
- “切り替わった”のが一瞬で分かるトランジションを 0.3〜0.6s だけ入れる
  - 例: 外枠が一回だけ強く発光 → すぐ戻る
  - 例: 背景のノイズ密度が一段上がる → 回転中は維持
- 回転表現:
  - 速度感（ブラー/縦スクロール）を出すが、数字が“見えなさすぎる”状態を作らない
  - 低スペック対策として CSS transform/opacity 中心にする

#### 3.2.1 リーチ者数が多い時の「じらし」（reachCount が取得できる場合のみ）
目的: “あと1が多い局面”で、止まる直前の期待を増幅し会場の声を引き出す。  
前提: reachCount が取得できない場合は、この節は無効（通常挙動）。

- 画面の隅に小さく `REACH x{reachCount}` を出す（回転中のみ / `?fx=0` では出さない）
- `reachIntensity` を次で決める（固定）:
  - reachCount <= 1: 0
  - 2..4: 1
  - 5..8: 2
  - >= 9: 3
- “じらし”は **最後に止まる桁** にだけ追加する（テンポを壊しにくい）
- GO→確定の総尺は上限を必ず守る（司会進行が止まるのを防ぐ）

| reachIntensity | 追加じらし（最後に止まる桁に加算） | 追加の「止まる直前ホールド」 | GO→確定 総尺上限 |
|---:|---:|---:|---:|
| 0 | +0ms | +0ms | 3.0s |
| 1 | +150〜250ms | +120〜220ms | 3.6s |
| 2 | +250〜450ms | +220〜380ms | 4.2s |
| 3 | +450〜650ms | +380〜520ms | 4.8s |

- safeモード:
  - `?safe=1` のときは reachIntensity を最大でも 1 として扱う（過度なじらしを抑制）

### 3.3 片側停止（十 or 一が止まる）
- 止まった桁:
  - “重く止まった”感（短いclunk + 微反動）を入れる
  - 停止した桁だけ枠発光を少し強める
- まだ回っている桁:
  - 背景/枠の“熱量”を維持して期待を引っ張る（煽り過ぎない）
- 3.2.1 が有効な場合:
  - 最後に止まる桁は「止まる直前ホールド」を入れてから確定へ（ただし総尺上限厳守）

### 3.4 両側停止（確定）
- 確定の瞬間:
  - 0.12〜0.20s の“インパクト”を1回だけ入れる（強点滅は禁止）
  - 直後 0.8〜1.2s は「読みやすさ最大モード」へ:
    - 背景を一段暗く落とす（数字が浮く）
    - 数字の輪郭/発光を最適化（遠目可読）
    - 小さく `CONFIRMED` ラベル（邪魔なら省略可）
- その後:
  - 余韻として背景質感を少し残しつつ IDLE に戻す

### 3.5 BINGO（表示側で検知/受信できる場合のみ）
#### 3.5.1 祝祭（2秒以内で収束）
- 2 秒以内の祝祭演出:
  - コイン/紙吹雪“少量”（数字領域を避ける）
  - `BINGO!` の短いオーバーレイ
- 2 秒経過で必ず収束し、次の進行を邪魔しない

#### 3.5.2 勝者名（winnerName）が取れる場合の“豪華さ”規定（必須）
目的: ピークを最大化し、会場に拍手/歓声の時間を作る（ただし進行を止めない）。

- 表示条件:
  - winnerName（または複数名の winnerNames）が取れる場合のみ表示
  - 取れない場合は `BINGO!` のみ（3.5.1 で完結）
- 名前の扱い（壊れ防止）:
  - 1行固定・省略記号（…）あり
  - 最大表示長の目安: 18文字（超える場合は自動省略）
  - 禁則: 改行・極端な絵文字連打でレイアウトが崩れないこと

- タイムライン（固定）:
  - 0ms: `BINGO!` ロゴ出現（中央）
  - 250〜650ms: winnerName を遅れて出す（“溜め”を作る）
  - 650〜3000ms: winnerName を主役として固定表示（読める時間を確保）
  - 3000〜3800ms: フェードアウト
  - 4.0s 以内に必ず通常表示へ復帰

- レイヤ/可読性:
  - winnerName は最上位レイヤ
  - 背景が暴れても読めるよう、縁取り＋影＋背面プレート（暗）を必須
  - 数字は必ず読める位置に残す（例: 確定数字を小さく枠付きで上部に退避）

- 豪華さ（Tier）:
  - Tier A（winner 1名）:
    - 発光枠 + 少量コイン/紙吹雪 + 1回だけ外周パルス（点滅ではなく発光量変化）
  - Tier S（同時に2名以上）:
    - 中央は先頭1名を大きく
    - 下に `WINNERS` を最大5名まで表示（6名以上は「ほか n 名」）
    - 祝祭はTier Aより少し強いが、2秒以内に収束は厳守

### 3.6 切断/遅延（WS不安定）
- 表示は落ち着いて:
  - 直近の数字は保持
  - 小さく `RECONNECTING…`（点滅なし）
- 演出は停止または最小に落とす（負荷削減を優先）

---

## 4. 音
既存のoggの利用を拡大せよ
oggファイル名が内容の説明になっているので，演出に活用するように

---

## 5. 安全・当日保険（最小）
- 強い点滅は禁止（（目安）1秒に3回を超える閃光を作らない）。
- `?fx=0` / `?safe=1` を必ず実装する（当日即死回避）。
- `prefers-reduced-motion` は `safe=1` 相当へ自動寄せ（可能なら）。

---

## 6. 実装の約束（Codexが迷わないために）
- 既存の“状態/イベント”を調べ、以下のタイミングにフックする（名前は既存に合わせる）:
  - GO（回転開始）
  - digit stop（片側停止）
  - confirmed（両側停止）
  - bingo（あれば）
  - disconnect/reconnect（あれば）
  - reachCount 更新（取れる場合のみ）
- 会場表示（十/一）は同じ演出コードを共有し、role（TEN/ONE）だけで分岐する。
- 3.2.1 / 3.5.2 は「データが取れる場合だけ」発動する（取れないときに壊れない）。

---

## 7. 受け入れチェック（会場で合格にする条件）
- [ ] IDLEでも画面が“止まって見えない”（薄い質感 + 呼吸）
- [ ] GOで会場の注意がスクリーンへ集まる（短い切替＋回転の勢い）
- [ ] 片側停止で“間”が生まれる（clunk + 停止桁強調）
- [ ] 確定直後は数字が一番読みやすい（背景を落とす）
- [ ] reachCount が高いとき、表どおりに「最後に止まる桁」がじらす（総尺上限厳守）
- [ ] BINGO（あれば）は2秒以内で祝祭→収束
- [ ] winnerName が取れる場合、3.5.2 のタイムライン/豪華さ/可読性を満たす
- [ ] `?fx=0` / `?safe=1` が効く（当日保険）
- [ ] 低スペックでも破綻しない（重ければ safe に自動寄せてもよい）

---

## 8. 手動スモーク（READMEの手順を踏襲）
1. `npm run dev`
2. トップ画面「Dev: セッション作成」
3. 会場表示（十の位・一の位）のURLを開く（できれば別画面/別PC）
4. Admin招待リンク（`/i/:token`）→「入室」→ `P` → `W/A/S/D`
5. 会場表示が 回転→片側停止→確定 を“気持ちよく”見せ、参加者の更新も壊れていないこと
6. リーチが増えた状態で `W/A/S/D` を繰り返し、3.2.1 の「じらし」が効くこと（取れる場合）
7. ビンゴを出して 3.5.2 の勝者名演出が仕様どおりに出ること（取れる場合）
8. `?fx=0` / `?safe=1` も確認
